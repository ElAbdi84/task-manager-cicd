AWSTemplateFormatVersion: '2010-09-09'
Description: 'Security Groups pour Task Manager'

Parameters:
  EnvironmentName:
    Description: Environment name prefix
    Type: String
    Default: TaskManager

  IPAddress:
    Description:  IP address for SSH access
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: ^(\d{1,3}\.){3}\d{1,3}/\d{1,2}$

Resources:
  # ==================== Frontend Security Group ====================
  FrontendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-Frontend-SG
      GroupDescription: Security group for frontend EC2 instance
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VPC-ID
      SecurityGroupIngress:
        # SSH access from my IP
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref IPAddress
          Description: SSH access from my IP
        
        # HTTP access from anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP access from internet
        
        # HTTPS access from anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS access from internet
      
      SecurityGroupEgress:
        # Allow all outbound traffic
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Frontend-SG

  # ==================== Backend Security Group ====================
  BackendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-Backend-SG
      GroupDescription: Security group for backend EC2 instance
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VPC-ID
      SecurityGroupIngress:
        # SSH access from Frontend
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref FrontendSecurityGroup
          Description: SSH access from Frontend
        
        # API access from Frontend (Node.js/Express)
        - IpProtocol: tcp
          FromPort: 5000
          ToPort: 5000
          SourceSecurityGroupId: !Ref FrontendSecurityGroup
          Description: API access from Frontend
        
        # MySQL access from Frontend (if needed for debugging)
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref FrontendSecurityGroup
          Description: MySQL access from Frontend
      
      SecurityGroupEgress:
        # Allow all outbound traffic
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Backend-SG

  # ==================== Backend Self-Reference ====================
  # Allow backend to connect to itself (for MySQL localhost)
  BackendSelfReferenceIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref BackendSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !Ref BackendSecurityGroup
      Description: MySQL access from same backend instance

# ==================== Outputs ====================
Outputs:
  FrontendSecurityGroup:
    Description: Frontend Security Group ID
    Value: !Ref FrontendSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-Frontend-SG-ID

  BackendSecurityGroup:
    Description: Backend Security Group ID
    Value: !Ref BackendSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-Backend-SG-ID